/*
 * stm32f446_rcc_driver.c
 *
 *  Created on: Oct 15, 2025
 *      Author: jiperez
 */
#include "stm32f446_rcc_driver.h"

/************************************************************************************
 * @fn				- SystemCLK_Config_84MHz
 *
 * @brief			- Configures internal clk to 84 MHz
 *
 * @param[in]		- none
 *
 * @return			- none
 *
 * @Note			- none
 */

void SystemCLK_Config_84MHz(void){

    RCC->CR |= (1 << 0);
    while((RCC->CR & (1 << 1)) == 0); // Wait for HSIRDY
    /*PLL_M = 8; 	HSI/PLL_M
    * PLL_N= 168;	PLL_N*HSI/PLL_M
   	* PLL_P = 4;	(PLL_N*HSI/PLL_M)/PLL_P = Final_Frequency
   	*/
    RCC->PLLCFGR &=~((0x7F << 24) | (1 << 22) | (0x3 << 16) | ( 0x7FF << 0 ));
    RCC->PLLCFGR |= (8 << 0);    // PLLM = 8
    RCC->PLLCFGR |= (168 << 6);  // PLLN = 168
    RCC->PLLCFGR |= (1 << 16);   // PLLP = 4 (01 = divide by 4)
    RCC->PLLCFGR &= ~(1 << 22);  // HSI as PLL source (bit 22 = 0)


    RCC->CR |= (1 << 24);
    while((RCC->CR & (1 << 25)) == 0); // Wait for PLLRDY


    FLASH->ACR |= (2 << 0);


    RCC->CFGR &= ~((0xFF << 24) | (0x1FFF << 10) | ( 0xFF << 0 ));
    RCC->CFGR |= (4 << 10);   // APB1 = /2 (42MHz)
    RCC->CFGR |= (4 << 13);   // APB2 = /2 (42MHz)


    RCC->CFGR |= (2 << 0);
    while((RCC->CFGR & (3 << 2)) != (2 << 2)); // Wait for SWS = PLL
}
