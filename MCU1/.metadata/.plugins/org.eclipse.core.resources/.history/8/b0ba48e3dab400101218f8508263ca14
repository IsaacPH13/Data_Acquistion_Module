/*
 * 014PWM.c
 *
 *  Created on: Oct 29, 2025
 *      Author: jiperez
 */
#include "stm32f446.h"

#define INC		82
#define DC
TIM_Handle_t *pTIM ;
GPIO_Handle_t *pGPIO;
int main(void)
{
	SystemCLK_Config_84MHz();

	SCB_CPACR |= ((3UL << 10*2) | (3UL << 11*2));

	GPIO_Handle_t GpioPWM;
	pGPIO = &GpioPWM;
	GPIO_PeriClockControl(GPIOA, ENABLE);

	GpioPWM.pGPIOx = GPIOA;
	GpioPWM.GPIO_PinConfig.GPIO_PinNumber = GPIO_PIN_NO_7;
	GpioPWM.GPIO_PinConfig.GPIO_PinMode = GPIO_MODE_OUTPUT;
	GpioPWM.GPIO_PinConfig.GPIO_PinSpeed = GPIO_SPEED_FAST;
	GpioPWM.GPIO_PinConfig.GPIO_PinOPType = GPIO_OP_TYPE_PP;
	GpioPWM.GPIO_PinConfig.GPIO_PinPuPdControl = GPIO_NO_PUPD;
	GPIO_Init(&GpioPWM);

	TIM_Handle_t TIM_1;
	pTIM = &TIM_1;
	TIM_1.pTIMx = TIM1;
	TIM_1.TIM_Config.TIM_Frequency = 9600;
	TIM_1.TIM_Config.TIM_CLKDivision = TIM_CKD_DIV1;
	TIM_1.TIM_Config.TIM_AutoReloadPreload = TIM_ARPE_ENABLE;
	TIM_1.TIM_Config.TIM_CNTMode = TIM_UPCOUNT_MODE;
	TIM_1.TIM_Config.TIM_IntEnable = TIM_IT_ENABLE;
	TIM_1.TIM_Config.TIM_MasterModeSel = TIM_MMS_UPDATE;
	TIM_Init(&TIM_1);

	TIM_Start(&TIM_1);
	TIM_IRQInterruptConfig(IRQ_NO_TIM1, ENABLE);
	TIM_IRQPriorityConfig(IRQ_NO_TIM1, 0);

	while(1);
	return 0;
}

void TIM1_IRQHandler(void)
{
	static float cont = 0;
	static uint8_t dir = 0;
	TIM_IRQHandling(pTIM);

	if((dir==0) && (cont<4095)) cont+=INC;
	else if((dir==0) && (cont>=4095)) dir = 1;

	if((dir==1) && (cont>0)) cont-=INC;
	else if((dir==1) && (cont<=0)) dir = 0;

	if(DC > cont) GPIO_WriteToOutputPin(GPIOA, 7, 1);
	else if(DC <= cont)GPIO_WriteToOutputPin(pGPIOA, 7, 0);
}

